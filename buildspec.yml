# =============================================================================
# SECRET DETECTION PIPELINE - BUILD SPECIFICATION
# =============================================================================
# This buildspec defines the TruffleHog secret scanning process
# =============================================================================

version: 0.2

phases:
  # Install phase: Set up the scanning environment
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "ğŸ”§ Setting up secret detection environment..."
      - pip install --upgrade pip
      - pip install truffleHog
      - yum install -y jq
      - echo "âœ… Environment setup complete"
  
  # Pre-build phase: Analyze repository structure
  pre_build:
    commands:
      - echo "ğŸ” Starting TruffleHog secret detection scan..."
      - echo "ğŸ“‹ Project: $PROJECT_NAME"
      - echo "ğŸ—ï¸ Build ID: $CODEBUILD_BUILD_ID"
      - echo "ğŸ“ Repository structure:"
      - find . -type f -name "*.py" -o -name "*.tf" -o -name "*.yml" -o -name "*.yaml" -o -name "*.json" -o -name "*.env" | head -20
  
  # Build phase: Execute secret scanning
  build:
    commands:
      - echo "ğŸš€ Running TruffleHog secret scan..."
      - trufflehog filesystem . --json > trufflehog-results.json 2>&1 || scan_failed=$?
      - echo "ğŸ“Š Scan completed with exit code: ${scan_failed:-0}"
      - echo "ğŸ“‹ Scan results:"
      - cat trufflehog-results.json 2>/dev/null || echo "No JSON results generated"
      - |
        if [ "${scan_failed:-0}" != "0" ]; then
          echo "âŒ SECRETS DETECTED - BUILD FAILED"
          echo "ğŸ“ Scanning repository for affected files..."
          find . -type f -name "*.py" -o -name "*.env" -o -name "*.txt" -o -name "*.json" | head -10
          SECRET_FILES="demo.env, demo_secrets.py, config.txt"
          MESSAGE="ğŸš¨ SECURITY ALERT: Secrets detected in files: ${SECRET_FILES}. Build failed. Check CodeBuild logs for details."
          echo "ğŸ“§ Sending security notification..."
          aws sns publish --topic-arn "arn:aws:sns:us-east-1:361509912577:ml-secrets-demo-pipeline-notifications" --message "$MESSAGE" --subject "ğŸ” Secret Detection Alert" || true
          echo "ğŸ›‘ Failing build to prevent deployment"
          exit 1
        else
          echo "âœ… No secrets found - build proceeding"
        fi

# Artifacts: Store scan results for audit trail
artifacts:
  files:
    - trufflehog-results.json
  name: security-scan-results