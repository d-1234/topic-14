# =============================================================================
# RESULTS ANALYSIS BUILDSPEC - STAGE 3
# =============================================================================
# This buildspec analyzes TruffleHog results and determines pipeline flow
# =============================================================================

version: 0.2

phases:
  # Install phase: Set up analysis tools
  install:
    runtime-versions:
      python: 3.11
    commands:
      - echo "ðŸ”§ Installing analysis tools..."
      - pip install --upgrade pip
      - yum install -y jq
      - echo "âœ… Analysis tools ready"
  
  # Pre-build phase: Prepare analysis
  pre_build:
    commands:
      - echo "ðŸ” Starting results analysis..."
      - echo "ðŸ“‹ Project: $PROJECT_NAME"
      - echo "ðŸ—ï¸ Build ID: $CODEBUILD_BUILD_ID"
      - echo "ðŸ“„ Input scan results:"
      - ls -la trufflehog-results.json 2>/dev/null || echo "No scan results file found"
  
  # Build phase: Analyze results and make decisions
  build:
    commands:
      - echo "ðŸ§  Analyzing TruffleHog scan results..."
      - |
        # Check if results file exists and has content
        if [ -f "trufflehog-results.json" ] && [ -s "trufflehog-results.json" ]; then
          echo "ðŸ“Š Scan results found, analyzing content..."
          
          # Count number of secrets detected
          SECRET_COUNT=$(cat trufflehog-results.json | jq '. | length' 2>/dev/null || echo "0")
          echo "ðŸ”¢ Secrets detected: $SECRET_COUNT"
          
          if [ "$SECRET_COUNT" -gt 0 ]; then
            echo "âŒ SECRETS DETECTED - PIPELINE WILL BE BLOCKED"
            
            # Extract filenames with secrets
            SECRET_FILES=$(cat trufflehog-results.json | jq -r '.[].SourceMetadata.Data.Filesystem.file // "unknown"' 2>/dev/null | sort -u | tr '\n' ', ' | sed 's/,$//' || echo "demo.env, demo_secrets.py")
            
            # Create analysis output
            echo "{\"status\":\"FAILED\",\"secret_count\":$SECRET_COUNT,\"files\":\"$SECRET_FILES\",\"message\":\"ðŸš¨ SECURITY VIOLATION: $SECRET_COUNT secrets detected in files: $SECRET_FILES\"}" > analysis-results.json
            
            # Send immediate notification
            aws sns publish --topic-arn "$SNS_TOPIC_ARN" --message "ðŸš¨ SECURITY ALERT: $SECRET_COUNT secrets detected in repository. Files affected: $SECRET_FILES. Pipeline execution blocked." --subject "ðŸ” Secret Detection Alert" || true
            
            echo "ðŸš¨ Security violation detected - pipeline will be stopped"
            exit 1
          else
            echo "âœ… NO SECRETS DETECTED - PIPELINE CAN CONTINUE"
            echo "{\"status\":\"SUCCESS\",\"secret_count\":0,\"files\":\"\",\"message\":\"âœ… No secrets detected - safe to deploy\"}" > analysis-results.json
          fi
        else
          echo "âš ï¸ No scan results found - assuming clean"
          echo "{\"status\":\"SUCCESS\",\"secret_count\":0,\"files\":\"\",\"message\":\"âœ… No scan results - assuming clean\"}" > analysis-results.json
        fi
      
      - echo "ðŸ“‹ Analysis complete:"
      - cat analysis-results.json
      - echo "âœ… Results analysis stage complete"

# Output analysis results for pipeline decisions
artifacts:
  files:
    - analysis-results.json
    - trufflehog-results.json
  name: analysis-results-artifact